<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Czytaj Zaznaczenie v3</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 1rem;
            line-height: 1.6;
            font-size: 17px;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
        }
        #main-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; }
        #instructions {
            background-color: #e7f3ff;
            border-left: 5px solid #007bff;
            padding: 10px 15px;
            margin: 1rem 0;
            border-radius: 5px;
        }
        #status {
            text-align: center;
            margin-top: 1rem;
            font-weight: bold;
            color: #007bff;
            min-height: 24px;
        }
        #debug-container {
            margin-top: 2rem;
            border-top: 1px solid #ccc;
            padding-top: 1rem;
        }
        #debug-log {
            background-color: #282c34;
            color: #abb2bf;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <div id="main-container">
        <h1>Czytnik Tekstu</h1>
        <div id="instructions">
            <!-- Instrukcje zostaną wstawione przez JS -->
        </div>
        
        <p>To jest przykładowy tekst do przetestowania aplikacji. Zaznacz fragment, a syntezator mowy go odczyta. Technologia ta nazywa się Web Speech API i jest wbudowana w nowoczesne przeglądarki.</p>
        <p>Działanie aplikacji dostosowuje się do Twojego urządzenia. Poniżej znajduje się konsola debugowania, która wyświetla informacje o jej działaniu.</p>
        
        <div id="status">Czekam na zaznaczenie...</div>
    </div>

    <div id="debug-container">
        <h3>Konsola debugowania:</h3>
        <pre id="debug-log"></pre>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const statusEl = document.getElementById('status');
            const logEl = document.getElementById('debug-log');
            const instructionsEl = document.getElementById('instructions');
            let lastSpokenText = '';
            let debounceTimeout;

            const log = (message) => {
                const time = new Date().toLocaleTimeString();
                logEl.innerHTML += `[${time}] ${message}\n`;
                logEl.scrollTop = logEl.scrollHeight;
                console.log(message);
            };

            window.onerror = (message, source, lineno) => {
                log(`BŁĄD: ${message} w ${source}:${lineno}`);
                return true;
            };

            log('Aplikacja zainicjowana.');

            if (!('speechSynthesis' in window)) {
                const msg = 'BŁĄD KRYTYCZNY: Twoja przeglądarka nie wspiera Web Speech API.';
                statusEl.textContent = msg;
                log(msg);
                return;
            }
            log('Web Speech API jest dostępne.');

            const speak = (text) => {
                if (!text || text.trim().length === 0) {
                    log('Pusty tekst, anuluję czytanie.');
                    return;
                }
                if (text === lastSpokenText && window.speechSynthesis.speaking) {
                    log('Ten sam tekst jest już czytany. Ignoruję.');
                    return;
                }
                
                log(`Próba odczytania: "${text}"`);
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'pl-PL';
                
                utterance.onstart = () => {
                    lastSpokenText = text;
                    statusEl.textContent = 'Czytam...';
                    log('Rozpoczęto czytanie.');
                };
                
                utterance.onend = () => {
                    statusEl.textContent = 'Zakończono. Zaznacz nowy tekst.';
                    log('Zakończono czytanie.');
                };

                utterance.onerror = (event) => {
                    const errorMsg = `Błąd syntezy mowy: ${event.error}`;
                    statusEl.textContent = 'Wystąpił błąd.';
                    log(errorMsg);
                };

                window.speechSynthesis.speak(utterance);
            };

            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            log(`Wykryto platformę: ${isIOS ? 'iOS' : 'Inna (Android/Desktop)'}`);

            if (isIOS) {
                instructionsEl.innerHTML = `
                    <b>Instrukcja (iOS):</b>
                    <ol>
                        <li>Zaznacz dowolny tekst na tej stronie.</li>
                        <li>Po zaznaczeniu, <b>dotknij ekranu</b>, aby odsłuchać.</li>
                    </ol>`;
                log('Tryb iOS: Wymagane dotknięcie po zaznaczeniu.');
                
                document.addEventListener('touchend', () => {
                    const currentSelection = window.getSelection().toString().trim();
                    log('Zdarzenie "touchend" (iOS).');
                    if (currentSelection) {
                        speak(currentSelection);
                    }
                });

            } else { // Android / Desktop
                instructionsEl.innerHTML = `
                    <b>Instrukcja (Android/PC):</b>
                    <ol>
                        <li>Zaznacz dowolny tekst na tej stronie.</li>
                        <li>Czytanie rozpocznie się automatycznie.</li>
                    </ol>`;
                log('Tryb Android/Desktop: Czytanie automatyczne.');

                document.addEventListener('selectionchange', () => {
                    clearTimeout(debounceTimeout);
                    const selection = window.getSelection().toString().trim();
                    
                    if (selection) {
                        debounceTimeout = setTimeout(() => {
                            log('Timer zakończony. Uruchamiam czytanie.');
                            speak(selection);
                        }, 400); // Czekaj 400ms po ostatniej zmianie zaznaczenia
                    } else {
                        window.speechSynthesis.cancel();
                        lastSpokenText = '';
                    }
                });
            }
        });
    </script>

</body>
</html>
